<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<link rel="import" href="rest-config.html">

<!--
An element wrapping iron-ajax to handle REST request.

Example:

    <rest-config
      api-url="jsonplaceholder.typicode.com">
    </rest-config>

    <rest-service
      id="rest"
      ressource="/posts"
      method="POST"
      body="[[_body]]"
      on-response="handleResponse"
      on-error="handleError">
    </rest-service>

@demo
-->
<dom-module id="rest-service">

  <template>

    <rest-config
      api-url="{{_apiUrl}}"
      with-credentials="{{_withCredentials}}"
      ssl="{{_ssl}}">
    </rest-config>

    <iron-ajax 
      id="ajax" 
      auto="{{auto}}"
      on-error="_errorHandler"
      on-response="_responseHandler"
      last-response="{{items}}"
      handleAs="json"
      method="{{method}}"
      params="{{params}}"
      body="{{body}}"
      content-type="{{contentType}}"
      with-credentials="{{_withCredentials}}">
    </iron-ajax>
    
    <paper-toast 
      id="toast"
      duration="5000">
    </paper-toast>

  </template>

</dom-module>

<script>
  Polymer({

    is: 'rest-service',

    properties: {

      /**
       * Auto comportment of iron-ajax. Automatically performs an Ajax request when either url or params changes.
       * @type {Boolean}
       */
      auto: {
        type: Boolean,
        value: false
      },

      /**
       * HTTP method to use such as GET, POST, DELETE, PUT.
       * @type {String}
       */
      method: {
        type: String,
        value: 'GET'
      },

      /**
       * API Url. All the slash will be removed.
       * @type {String}
       */
      _apiUrl: {
        type: String
      },

      /**
       * Set the withCredentials flag on the request.
       * @type {Boolean}
       */
      _withCredentials: {
        type: Boolean,
        value: false
      },

       /**
       * Use HTTP or HTTPS to query the API.
       * @type {Boolean}
       */
      _ssl: {
        type: Boolean,
        value: false
      },

      /**
       * Ressource modified.
       * @type {String}
       */
      ressource: {
        type: String,
        observer: '_ressourceChanged'
      },

      /**
       * Element returned by the api after a request.
       * @type {Array}
       */
      items: {
        type: Array,
        notify: true
      },

      /**
       * An object that contains query parameters to be appended to the specified url when generating a request.
       * @type {Object}
       */
      params: {
        type: Object
      },

      /**
       * Optional raw body content to send when method === "POST". Must be a String. Trailing slash will be removed.
       * @type {String}
       */
      body: {
        type: String
      },

      /**
       * Content type to use when sending data.
       * @type {String}
       * @default application/json
       */
      contentType: {
        type: String,
        value: 'application/json'
      }
    },

    observers: [
      '_updateUrl(_apiUrl, ressource, _ssl)'
    ],

    // Element Behavior

    /**
     * The `rest-error` event is fired whenever a request failed.
     *
     * @event rest-error
     * @detail {Object}
     */
    
    /**
     * The `rest-response` event is fired whenever a request succeed.
     *
     * @event rest-response
     * @detail {Object}
     */
    
    /**
     * Handle an error returned by the api.
     * @param  {Event} e Event generated by iron-ajax
     */
    _errorHandler: function(e) {
      this.$.toast.text = 'There was a problem to load ' + this.ressource + '.';
      this.$.toast.show();
      this.fire('rest-error', e.detail);
    },

    /**
     * Handle a response returned by the api.
     * @param  {Event} e Event generated by iron-ajax
     */
    _responseHandler: function(e) {
      this.fire('rest-response', e.detail);
    },

    /**
     * Reformat the ressource name whenever it changes
     * @param  {String} newValue Ressource name after change
     * @return {Strng }          Ressource name reformated
     */
    _ressourceChanged: function(newValue) {
      newValue = newValue.replace(/^\//, '');
      newValue = newValue.replace(/\/$/, '');
      this.ressource = newValue;
      return newValue;
    },

    /**
     * Recompute the url based on the api url, the ressource and ssl configuration.
     * @param  {String} _apiUrl    Api url
     * @param  {String} ressource Ressource to be modified
     * @param  {Boolean} _ssl       Use HTTPS or HTTP to query the api
     */
    _updateUrl: function(_apiUrl, ressource, _ssl) {
      var url = ((_ssl) ? 'https' : 'http') + '://' + _apiUrl + '/' + ressource;
      this.$.ajax.url = url;
      return url;
    },

    /**
     * Send the ajax request
     */
    generateRequest: function() {
      this.$.ajax.generateRequest();
    }
  });
</script>
